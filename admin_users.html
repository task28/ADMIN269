<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { padding: 10px 20px; background: #34495e; color: white; text-decoration: none; border-radius: 5px; }
        
        .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; color: #333; }
        tr:hover { background: #f1f1f1; }
        
        .search-box { padding: 10px; width: 300px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; }

        /* Action Buttons */
        .btn-edit { background: #3498db; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 13px; }
        .btn-edit:hover { background: #2980b9; }

        /* MODAL (POPUP) STYLES */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 15% auto; padding: 30px; border-radius: 10px; width: 350px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideDown 0.3s; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        
        .modal input { width: 100%; padding: 12px; margin: 15px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; text-align: center; }
        .btn-save { background: #27ae60; color: white; width: 100%; padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        
        @keyframes slideDown { from {transform: translateY(-50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
    </style>
</head>
<body>

<div class="header">
    <h2>User List & Balance Manager</h2>
    <a href="admin_home.html" class="back-btn">Back to Dashboard</a>
</div>

<div class="table-container">
    <input type="text" id="search" class="search-box" placeholder="Search by Phone Number..." onkeyup="searchUser()">
    
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Balance ($)</th>
                <th>Total Tasks</th>
                <th>Action</th> <!-- নতুন কলাম -->
            </tr>
        </thead>
        <tbody id="user-table">
            <tr><td colspan="5">Loading data...</td></tr>
        </tbody>
    </table>
</div>

<!-- Balance Edit Modal -->
<div id="balanceModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 style="margin-top:0;">Edit Balance</h3>
        <p>User: <span id="modal-user-name" style="font-weight:bold; color:#3498db;"></span></p>
        
        <input type="hidden" id="modal-user-phone"> <!-- হিডেন ইনপুট -->
        
        <label style="font-size:12px; color:#555;">Enter New Balance ($):</label>
        <input type="number" id="modal-new-balance" step="0.01">
        
        <button class="btn-save" onclick="saveBalance()">Update Balance</button>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAa_T9MDAjSjQ4Us8C4O6Lqzus2d1_LRck",
    authDomain: "task-310c5.firebaseapp.com",
    projectId: "task-310c5",
    storageBucket: "task-310c5.firebasestorage.app",
    messagingSenderId: "503757001786",
    appId: "1:503757001786:web:3ba0943c3367c273de9103"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  if(localStorage.getItem("adminAuth") !== "true") window.location.href = "admin_login.html";

  // ইউজার ডেটা লোড
  onValue(ref(db, 'users'), (snapshot) => {
      const table = document.getElementById('user-table');
      table.innerHTML = "";
      
      if (!snapshot.exists()) {
          table.innerHTML = "<tr><td colspan='5'>No users found.</td></tr>";
          return;
      }

      snapshot.forEach((childSnapshot) => {
          const user = childSnapshot.val();
          
          const row = `
            <tr>
                <td>${user.name}</td>
                <td class="phone-col">${user.phone}</td>
                <td style="color:green; font-weight:bold;">$${parseFloat(user.balance).toFixed(2)}</td>
                <td>${user.total_tasks}</td>
                <td>
                    <button class="btn-edit" onclick="openModal('${user.phone}', '${user.name}', ${user.balance})">
                        ✏ Edit Balance
                    </button>
                </td>
            </tr>
          `;
          table.innerHTML += row;
      });
  });

  // সার্চ ফাংশন
  window.searchUser = function() {
      const input = document.getElementById('search').value.toLowerCase();
      const rows = document.querySelectorAll('#user-table tr');
      rows.forEach(row => {
          const phone = row.querySelector('.phone-col')?.innerText.toLowerCase();
          if (phone && phone.includes(input)) row.style.display = "";
          else row.style.display = "none";
      });
  }

  // --- MODAL FUNCTIONS ---

  // ১. মডাল ওপেন করা এবং ভ্যালু সেট করা
  window.openModal = function(phone, name, balance) {
      document.getElementById('balanceModal').style.display = "block";
      document.getElementById('modal-user-name').innerText = name;
      document.getElementById('modal-user-phone').value = phone;
      document.getElementById('modal-new-balance').value = parseFloat(balance).toFixed(2);
  }

  // ২. মডাল বন্ধ করা
  window.closeModal = function() {
      document.getElementById('balanceModal').style.display = "none";
  }

  // ৩. ব্যালেন্স সেভ করা
  window.saveBalance = function() {
      const phone = document.getElementById('modal-user-phone').value;
      const newBalance = parseFloat(document.getElementById('modal-new-balance').value);

      if (isNaN(newBalance)) {
          alert("Please enter a valid number");
          return;
      }

      if(confirm(`Update balance for this user to $${newBalance}?`)) {
          update(ref(db, 'users/' + phone), {
              balance: newBalance
          }).then(() => {
              alert("Balance Updated Successfully!");
              closeModal();
          }).catch((err) => {
              alert("Error: " + err);
          });
      }
  }

  // উইন্ডোর বাইরে ক্লিক করলে মডাল বন্ধ হবে
  window.onclick = function(event) {
      const modal = document.getElementById('balanceModal');
      if (event.target == modal) {
          modal.style.display = "none";
      }
  }
</script>

</body>
</html>
